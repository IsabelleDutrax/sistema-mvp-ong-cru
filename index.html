<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>MVP Doa√ß√µes</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link href="https://cdn.jsdelivr.net/npm/@flaticon/flaticon-uicons/css/all/all.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h2 {
      margin-top: 30px;
    }

    input,
    button {
      margin: 5px;
      padding: 8px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
    }

    th {
      background: #f2f2f2;
    }

    .hidden {
      display: none;
    }

    .section {
      border: 1px solid #ddd;
      padding: 15px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h1>üí∞ MVP Doa√ß√µes - Supabase</h1>

  <!-- Login / Signup -->
  <div id="auth-section" class="section">
    <h2>Login / Cadastro</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Senha">
    <button onclick="signUp()">Cadastrar</button>
    <button onclick="signIn()">Entrar</button>
    <button onclick="signOut()"><i class="fi fi-rr-exit"></i></button>
  </div>

  <!-- Doadores -->
  <div id="doador-section" class="section hidden">
    <h2>Doadores</h2>
    <input type="text" id="doadorNome" placeholder="Nome">
    <input type="text" id="doadorTelefone" placeholder="Telefone">
    <input type="text" id="doadorCpf" placeholder="CPF/CNPJ">
    <input type="text" id="doadorEndereco" placeholder="Endere√ßo">
    <input type="email" id="doadorEmail" placeholder="E-mail">
    <button onclick="addDoador()">Adicionar</button>
    <table id="doadorTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>Email</th>
          <th>Telefone</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Doa√ß√µes -->
  <div id="doacao-section" class="section hidden">
    <h2>Doa√ß√µes</h2>
    <input type="number" id="doacaoValor" placeholder="Valor">
    <input type="date" id="doacaoData">
    <input type="text" id="doacaoForma" placeholder="Forma de Pagamento">
    <input type="text" id="idDoador" placeholder="Id do Doador">
    <button onclick="addDoacao()">Adicionar</button>
    <table id="doacaoTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Doador</th>
          <th>Valor</th>
          <th>Data</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Intera√ß√µes -->
  <div id="interacao-section" class="section hidden">
    <h2>Intera√ß√µes</h2>
    <input type="text" id="tipoInteracao" placeholder="Tipo">
    <input type="text" id="idDoadorInteracao" placeholder="ID do Doador">
    <input type="text" id="observacoes" placeholder="Observa√ß√µes">
    <button onclick="addInteracaoNova()">Adicionar</button>
    <table id="interacaoTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Doador ID</th>
          <th>Tipo</th>
          <th>Obs</th>
          <th>Data</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // üîë Config Supabase
    const SUPABASE_URL = "https://iqtxmepahwyqngibdabt.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlxdHhtZXBhaHd5cW5naWJkYWJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MzQ2NTcsImV4cCI6MjA3NDMxMDY1N30.fokYHtnx0ulKhrX6HBRp-eQRwgerjqIGcxe6kaEGjAo";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);


    let currentUser = null;
    let currentDoadorId = null;
    let isAdmin = false;

    // =========================
    // üîê AUTH
    // =========================



    //Email: admin@admin.com
    //Senha: 123123


    //Email: alvesisabele370@gmail.com
    //Senha: 123123


    async function signIn() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) return alert("Erro: " + error.message);

      currentUser = data.user;

      // Checa se o usu√°rio √© admin
      const { data: doadorData } = await supabaseClient
        .from("doador")
        .select("nivel_acesso")
        .eq("id_usuario", currentUser.id)
        .single();

      isAdmin = doadorData && doadorData.nivel_acesso === 99;

      // alert("Login OK! Admin: " + isAdmin);
      Swal.fire({
        icon: 'success',
        title: 'Successo!',
        text: `Login OK! Admin:${isAdmin}`,
        position: 'top-right',
        showConfirmButton: false,
        timer: 1500,
        timerProgressBar: true,
        toast: true,

        animation: true,
      })
      loadData();
      toggleSections(true);
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      toggleSections(false);
      // alert("Saiu!");
      Swal.fire({
        icon: 'success',
        title: 'Saiu!',
        position: 'top-right',
        showConfirmButton: false,
        timer: 1500,
        timerProgressBar: true,
        toast: true,

        animation: true,
      })
    }

    function toggleSections(show) {
      document.getElementById("doador-section").classList.toggle("hidden", !show);
      document.getElementById("doacao-section").classList.toggle("hidden", !show);
      document.getElementById("interacao-section").classList.toggle("hidden", !show);
    }

    // =========================
    // üßë DOADOR NOVO
    // =========================
    async function loadDoadores() {
      const { data, error } = await supabaseClient.from("doador_novo").select("*");
      if (error) return console.error(error);

      const tbody = document.querySelector("#doadorTable tbody");
      tbody.innerHTML = "";
      data.forEach(d => {
        tbody.innerHTML += `<tr>
      <td>${d.id_doador}</td>
      <td>${d.nome}</td>
      <td>${d.email || ""}</td>
      <td>${d.telefone || ""}</td>
      <td>
        <button onclick="updateDoador(${d.id_doador})"><i class="fi fi-rr-pencil"></i></button>
        <button onclick="deleteDoador(${d.id_doador})"><i class="fi fi-rr-trash"></i></button>
      </td>
    </tr>`;
      });
    }

    async function addDoador() {
      const nome = document.getElementById("doadorNome").value;
      const telefone = document.getElementById("doadorTelefone").value;
      const cpf = document.getElementById("doadorCpf").value;
      const endereco = document.getElementById("doadorEndereco").value;
      const email = document.getElementById("doadorEmail").value || ''; // opcional

      const { error } = await supabaseClient.from("doador_novo").insert({ nome, telefone, cpf_cnpj: cpf, endereco, email });
      if (error) return alert("Erro: " + error.message);
      loadDoadores();
    }

    async function updateDoador(id) {
      const nome = prompt("Novo nome do doador:");
      const telefone = prompt("Novo telefone:");
      const cpf = prompt("Novo CPF/CNPJ:");
      const endereco = prompt("Novo endere√ßo:");
      const email = prompt("Novo email (opcional):");

      const updateData = {};
      if (nome) updateData.nome = nome;
      if (telefone) updateData.telefone = telefone;
      if (cpf) updateData.cpf_cnpj = cpf;
      if (endereco) updateData.endereco = endereco;
      if (email) updateData.email = email;

      const { error } = await supabaseClient.from("doador_novo").update(updateData).eq("id_doador", id);
      if (error) return alert("Erro: " + error.message);
      loadDoadores();
    }


    async function deleteDoador(id) {
      if (!confirm("Tem certeza que deseja deletar este doador?")) return;
      const { error } = await supabaseClient.from("doador_novo").delete().eq("id_doador", id);
      if (error) return alert("Erro: " + error.message);
      loadDoadores();
    }

    // =========================
    // üí∏ DOA√á√ÉO NOVA
    // =========================
    async function loadDoacoes() {
      const { data, error } = await supabaseClient.from("doacao_nova").select("*");
      if (error) return console.error(error);

      const tbody = document.querySelector("#doacaoTable tbody");
      tbody.innerHTML = "";
      data.forEach(d => {
        tbody.innerHTML += `<tr>
      <td>${d.id_doacao}</td>
      <td>${d.id_doador}</td>
      <td>${d.valor}</td>
      <td>${d.data_doacao || ""}</td>
      <td>${d.status || ""}</td>
      <td>
        <button onclick="updateDoacao(${d.id_doacao})"><i class="fi fi-rr-pencil"></i></button>
        <button onclick="deleteDoacao(${d.id_doacao})"><i class="fi fi-rr-trash"></i></button>
      </td>
    </tr>`;
      });
    }

    async function addDoacao() {
      const valor = document.getElementById("doacaoValor").value;
      const dataDoacao = document.getElementById("doacaoData").value;
      const forma = document.getElementById("doacaoForma").value;
      const idDoador = document.getElementById("idDoador").value;

      // Verificar se o ID do doador existe na tabela doadores
      const { data: doador, error: doadorError } = await supabaseClient
        .from("doador_novo")
        .select("id_doador") // Seleciona todo o conte√∫do (ou s√≥ "id_doador" para otimizar)
        .eq("id_doador", idDoador)
        .single();

      // Tratamento dos erros ou aus√™ncia do doador no banco
      if (doadorError || !doador) {
        return alert("Doador n√£o encontrado! Verifique o ID informado.");
      }

      const { error } = await supabaseClient.from("doacao_nova").insert({
        id_doador: parseInt(idDoador),
        valor: parseFloat(valor),
        data_doacao: dataDoacao,
        forma_pagamento: forma
      });
      if (error) return alert("Erro: " + error.message);
      loadDoacoes();
    }

    async function updateDoacao(id) {
      const valor = prompt("Novo valor:");
      const forma = prompt("Nova forma de pagamento:");
      const status = prompt("Novo status:");

      const updateData = {};
      if (valor) updateData.valor = parseFloat(valor);
      if (forma) updateData.forma_pagamento = forma;
      if (status) updateData.status = status;

      const { error } = await supabaseClient.from("doacao_nova").update(updateData).eq("id_doacao", id);
      if (error) return alert("Erro: " + error.message);
      loadDoacoes();
    }

    async function deleteDoacao(id) {
      if (!confirm("Deseja deletar esta doa√ß√£o?")) return;
      const { error } = await supabaseClient.from("doacao_nova").delete().eq("id_doacao", id);
      if (error) return alert("Erro: " + error.message);
      loadDoacoes();
    }


    // =========================
    // üìû INTERA√á√ÉO NOVA
    // =========================
    async function loadInteracoes() {
      console.log("load das intera√ß√µes");
      let query = supabaseClient.from("interacao_nova").select("*");
      // if (!isAdmin) query = query.eq("id_doador", currentDoadorId);

      const { data, error } = await query;
      if (error) return console.error(error);

      const tbody = document.querySelector("#interacaoTable tbody");
      tbody.innerHTML = "";
      data.forEach(i => {
        tbody.innerHTML += `<tr>
      <td>${i.id_interacao}</td>
      <td>${i.id_doador || ""}</td>
      <td>${i.tipo_interacao}</td>
      <td>${i.observacoes || ""}</td>
      <td>${i.data_interacao}</td>
      <td>
        <button onclick="updateInteracaoNova(${i.id_interacao})"><i class="fi fi-rr-pencil"></i></button>
        ${isAdmin ? `<button onclick="deleteInteracaoNova(${i.id_interacao})"><i class="fi fi-rr-trash"></i></button>` : ""}
      </td>
    </tr>`;
      });
    }

    async function addInteracaoNova() {
      const tipo = document.getElementById("tipoInteracao").value;
      const obs = document.getElementById("observacoes").value;
      const idDoador = document.getElementById("idDoadorInteracao").value || '';

      // Verificar se o ID do doador existe na tabela doadores
      const { data: doador, error: doadorError } = await supabaseClient
        .from("doador_novo")
        .select("id_doador") // Seleciona todo o conte√∫do (ou s√≥ "id_doador" para otimizar)
        .eq("id_doador", idDoador)
        .single();

      // Tratamento dos erros ou aus√™ncia do doador no banco
      if (doadorError || !doador) {
        return alert("Doador n√£o encontrado! Verifique o ID informado.");
      }

      const { error } = await supabaseClient.from("interacao_nova").insert({
        id_doador: parseInt(idDoador),
        id_usuario: currentUser.id,
        tipo_interacao: tipo,
        observacoes: obs
      });
      if (error) return alert("Erro: " + error.message);

      Swal.fire({
        icon: 'success',
        title: 'Successo!',
        text: "Intera√ß√£o adicionada com sucesso!",
        position: 'top-right',
        showConfirmButton: false,
        timer: 1500,
        timerProgressBar: true,
        toast: true,
      })
      loadInteracoes();
    }

    async function updateInteracaoNova(id) {
      const tipo = prompt("Novo tipo:");
      const obs = prompt("Nova observa√ß√£o:");
      const { error } = await supabaseClient.from("interacao_nova")
        .update({ tipo_interacao: tipo, observacoes: obs })
        .eq("id_interacao", id);
      if (error) return alert("Erro: " + error.message);
      loadInteracoes();
    }

    async function deleteInteracaoNova(id) {
      if (!isAdmin) return alert("Somente admins podem deletar intera√ß√µes");
      if (!confirm("Deseja deletar esta intera√ß√£o?")) return;

      const { error } = await supabaseClient.from("interacao_nova")
        .delete()
        .eq("id_interacao", id);
      if (error) return alert("Erro: " + error.message);
      loadInteracoes();
    }


    // =========================
    // üöÄ Load inicial
    // =========================
    async function loadData() {
      await loadDoadores();
      await loadDoacoes();
      await loadInteracoes();
    }



  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>

</html>